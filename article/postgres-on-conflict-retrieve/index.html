<!DOCTYPE html>
<html>
  <head>
    <title>Postgres: On Conflict Retrieve</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="A Postgres feature request for supporting create-or-retrieve on INSERT statements."
    />
    <meta name="robots" content="noindex, nofollow" />

    <link
      rel="canonical"
      href="http://localhost:8620/_reserved/not-found.html"
    />
    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/logo192.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#178bfb" />

    <meta property="og:title" content="Postgres: On Conflict Retrieve" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Chris Andrejewski" />
    <meta
      property="og:url"
      content="http://localhost:8620/_reserved/not-found.html"
    />

    <link rel="stylesheet" href="/stylesheet/highlight-atom-one.css" />
    <style data-styled="true" data-styled-version="5.3.5">
      .cUDFKA {
        padding-bottom: 4rem;
      } /*!sc*/
      data-styled.g2[id='sc-gsnTZi'] {
        content: 'cUDFKA,';
      } /*!sc*/
      .ftgBFL {
        background-color: #fff;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ftgBFL {
          background-color: #16202e;
        }
      } /*!sc*/
      data-styled.g3[id='sc-dkzDqf'] {
        content: 'ftgBFL,';
      } /*!sc*/
      .iMPPhc {
        padding: 0px 1rem;
        max-width: 720px;
        margin: 0px auto;
      } /*!sc*/
      data-styled.g4[id='sc-hKMtZM'] {
        content: 'iMPPhc,';
      } /*!sc*/
      .jZkxEC {
        margin: 15px 0em;
      } /*!sc*/
      .jZkxEC:first-child {
        margin-top: 0px;
      } /*!sc*/
      .jZkxEC:last-child {
        margin-bottom: 0px;
      } /*!sc*/
      data-styled.g5[id='sc-eCYdqJ'] {
        content: 'jZkxEC,';
      } /*!sc*/
      .eBtA-dh {
        margin: 3rem 0;
      } /*!sc*/
      data-styled.g6[id='sc-jSMfEi'] {
        content: 'eBtA-dh,';
      } /*!sc*/
      .iUGkOU {
        font-size: 3rem;
        margin: 0px;
      } /*!sc*/
      data-styled.g7[id='sc-gKXOVf'] {
        content: 'iUGkOU,';
      } /*!sc*/
      .xFOWy {
        margin: 0;
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .xFOWy {
          color: #dbe0e7;
        }
      } /*!sc*/
      data-styled.g8[id='sc-iBkjds'] {
        content: 'xFOWy,';
      } /*!sc*/
      .gIJIXF {
        display: inline-block;
        font-size: 0.9rem;
        line-height: 1rem;
        background-color: #ffc87b;
        color: #151515;
        border-radius: 3px;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0.5rem 0.25rem 0;
        -webkit-text-decoration: none;
        text-decoration: none;
        white-space: nowrap;
      } /*!sc*/
      .gIJIXF:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .gIJIXF {
          background-color: #2f3d4e;
          color: #c8d2e0;
        }
      } /*!sc*/
      data-styled.g9[id='sc-ftvSup'] {
        content: 'gIJIXF,';
      } /*!sc*/
      .iHVwPn {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .iHVwPn:hover span {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .iHVwPn:hover:after {
        opacity: 1;
      } /*!sc*/
      .iHVwPn:after {
        content: 'ðŸ”—';
        padding: 0 0.5rem;
        font-size: 1rem;
        opacity: 0.25;
      } /*!sc*/
      data-styled.g10[id='sc-papXJ'] {
        content: 'iHVwPn,';
      } /*!sc*/
      * {
        box-sizing: border-box;
      } /*!sc*/
      body {
        margin: 0px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica,
          Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
          'Segoe UI Symbol';
        background-color: #fef2e7;
        color: #000;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #0d1117;
          color: #fff;
        }
      } /*!sc*/
      data-styled.g12[id='sc-global-eIVHya1'] {
        content: 'sc-global-eIVHya1,';
      } /*!sc*/
      .fyabtt {
        padding: 1rem 0px;
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: justify;
        -webkit-justify-content: space-between;
        -ms-flex-pack: justify;
        justify-content: space-between;
        -webkit-align-items: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
      } /*!sc*/
      .fyabtt h1 {
        font-size: 1.5rem;
        margin: 0;
      } /*!sc*/
      .fyabtt h1 a {
        -webkit-text-decoration: none;
        text-decoration: none;
        color: inherit;
      } /*!sc*/
      .fyabtt h1 a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .fyabtt ul {
        list-style: none;
        margin: 0;
        padding: 0;
        text-align: right;
      } /*!sc*/
      .fyabtt ul li {
        display: inline-block;
        padding: 0px 0.5rem;
        text-align: right;
      } /*!sc*/
      data-styled.g13[id='sc-kDDrLX'] {
        content: 'fyabtt,';
      } /*!sc*/
      .dXbzen h1 > a,
      .dXbzen h2 > a,
      .dXbzen h3 > a,
      .dXbzen h4 > a,
      .dXbzen h5 > a,
      .dXbzen h6 > a {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .dXbzen h1 > a:hover,
      .dXbzen h2 > a:hover,
      .dXbzen h3 > a:hover,
      .dXbzen h4 > a:hover,
      .dXbzen h5 > a:hover,
      .dXbzen h6 > a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .dXbzen p,
      .dXbzen li {
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .dXbzen p,
        .dXbzen li {
          color: #dbe0e7;
        }
      } /*!sc*/
      .dXbzen a {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .dXbzen a {
          color: #5eb6ff;
        }
      } /*!sc*/
      .dXbzen ul {
        padding-left: 1rem;
      } /*!sc*/
      .dXbzen code {
        font-family: Monaco, monospace;
      } /*!sc*/
      .dXbzen h1 code,
      .dXbzen h2 code,
      .dXbzen h3 code,
      .dXbzen h4 code,
      .dXbzen h5 code,
      .dXbzen h6 code,
      .dXbzen li code,
      .dXbzen p code {
        font-size: 0.9em;
        padding: 0 0.25em;
        border-radius: 3px;
        background-color: #ffeeda;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .dXbzen h1 code,
        .dXbzen h2 code,
        .dXbzen h3 code,
        .dXbzen h4 code,
        .dXbzen h5 code,
        .dXbzen h6 code,
        .dXbzen li code,
        .dXbzen p code {
          background-color: #2b3644;
        }
      } /*!sc*/
      .dXbzen pre {
        background-color: #ffeed9;
        padding: 0.5rem 0.75rem;
        overflow-x: scroll;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .dXbzen pre {
          background-color: #2b3645;
        }
      } /*!sc*/
      .dXbzen img {
        display: block;
        max-width: 100%;
        max-height: 520px;
        font-size: 0;
        margin: 0px auto;
        padding: 0px;
      } /*!sc*/
      .dXbzen video {
        display: block;
        margin: 1rem auto;
      } /*!sc*/
      .dXbzen figure {
        text-align: center;
        margin: 20px 0px;
      } /*!sc*/
      .dXbzen figure img {
        display: block;
        max-width: 90vw;
        margin: 0px auto;
      } /*!sc*/
      .dXbzen figure figcaption {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px auto;
      } /*!sc*/
      .dXbzen .cali-collage {
        padding: 20px 0px;
        text-align: center;
      } /*!sc*/
      .dXbzen .cali-collage img {
        display: inline-block;
        margin: 10px;
        max-width: 95vw;
        vertical-align: middle;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      } /*!sc*/
      data-styled.g15[id='sc-crXcEl'] {
        content: 'dXbzen,';
      } /*!sc*/
    </style>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-G3SKTPFTEZ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag('js', new Date())
      gtag('config', 'G-G3SKTPFTEZ')
    </script>
  </head>
  <body>
    <div class="sc-dkzDqf ftgBFL">
      <div class="sc-gsnTZi cUDFKA">
        <div class="sc-dkzDqf ftgBFL">
          <div class="sc-hKMtZM iMPPhc">
            <nav class="sc-kDDrLX fyabtt">
              <h1><a href="/">Chris Andrejewski</a></h1>
            </nav>
          </div>
        </div>
        <div class="sc-hKMtZM iMPPhc">
          <div class="sc-jSMfEi eBtA-dh">
            <p class="sc-iBkjds xFOWy">
              <a
                href="/category/engineering/index.html"
                class="sc-ftvSup gIJIXF"
                >Engineering</a
              >
            </p>
            <h1 class="sc-gKXOVf iUGkOU">
              <a href="#" class="sc-papXJ iHVwPn"
                ><span>Postgres: On Conflict Retrieve</span></a
              >
            </h1>
            <p class="sc-iBkjds xFOWy">
              A Postgres feature request for supporting create-or-retrieve on
              INSERT statements.
            </p>
          </div>
          <div class="sc-eCYdqJ jZkxEC">
            <div class="sc-crXcEl dXbzen">
              <p>
                There's a feature I really want for Postgres. I call it
                <code>ON CONFLICT RETRIEVE</code>.<br />
                Basically I want to be able to do:
              </p>
              <pre><code class="language-sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> dog_breeds (
  id serial,
  name text,

  <span class="hljs-keyword">CONSTRAINT</span> unique_name <span class="hljs-keyword">UNIQUE</span> (name)
);

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dog_breeds (name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;labrador&#x27;</span>)
RETURNING (id);

<span class="hljs-comment">-- =&gt;</span>
<span class="hljs-comment">--  id</span>
<span class="hljs-comment">-- ----</span>
<span class="hljs-comment">--   1</span>
<span class="hljs-comment">-- (1 row)</span>

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dog_breeds (name)
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">&#x27;labrador&#x27;</span>)
<span class="hljs-keyword">ON</span> CONFLICT <span class="hljs-keyword">ON</span> <span class="hljs-keyword">CONSTRAINT</span> unique_name RETRIEVE
RETURNING (id);

<span class="hljs-comment">-- =&gt;</span>
<span class="hljs-comment">--  id</span>
<span class="hljs-comment">-- ----</span>
<span class="hljs-comment">--   1</span>
<span class="hljs-comment">-- (1 row)</span>
</code></pre>
              <p>
                In a single statement, I can attempt to insert a record and if
                it already exists just return the conflicting record.
              </p>
              <p>
                Without this feature, we tend to write application code that
                looks like this:
              </p>
              <pre><code class="language-js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createOrRetrieveDogBreedId</span>(<span class="hljs-params">db, dogBreedName</span>) {
  <span class="hljs-comment">// See note A</span>
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">exec</span>(
      <span class="hljs-string">`INSERT INTO dog_breeds (name) VALUES (?) RETURNING (id)`</span>,
      [dogBreedName]
    )

    <span class="hljs-keyword">return</span> result.<span class="hljs-property">rows</span>[<span class="hljs-number">0</span>].<span class="hljs-property">id</span>
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// See note B</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isDogNameUniqueConstraintError</span>(error)) {
      <span class="hljs-keyword">throw</span> error
    }

    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> db.<span class="hljs-title function_">exec</span>(<span class="hljs-string">`SELECT id from dog_breeds where name = ?`</span>, [
      dogBreedName,
    ])
    <span class="hljs-keyword">const</span> id = result.<span class="hljs-property">rows</span>[<span class="hljs-number">0</span>]?.<span class="hljs-property">id</span>

    <span class="hljs-comment">// See note C</span>
    <span class="hljs-keyword">return</span> id
  }
}
</code></pre>
              <p>
                <strong>Note A</strong>: In a distributed context, you generally
                want to attempt the <code>INSERT</code> then
                <code>SELECT</code> if needed. This is because two processes may
                both query for a result, find nothing, and then both attempt to
                <code>INSERT</code>. This means one will hit the unique
                constraint error and need to handle it anyway.
              </p>
              <p>
                <strong>Note B</strong>: Detecting constraint errors is
                relatively straight forward. Most Postgres drivers will return
                the name of the constraint that was violated so you just need to
                make sure your application's understanding of the constraint
                names matches the database naming. The potential for mismatch is
                reason to explicitly name constraints which is a good idea in
                general.
              </p>
              <p><strong>Note C</strong>: Here we have to make a choice:</p>
              <ol>
                <li>
                  <p>
                    Assume it is highly unlikely that the dog breed was deleted
                    or changed since trying to insert. This gets more and more
                    risky in GC'd languages where your application might pause
                    at random points between queries or when database request
                    latency is high.
                  </p>
                </li>
                <li>
                  <p>
                    If the ID is not returned, try the create-or-retrieve again
                    until you succeed. A programmer might reach for recursion to
                    drive towards a consistent state, which is problematic for
                    reliable systems. For example, if
                    <code>isDogNameUniqueConstraintError</code> is implemented
                    incorrectly, this function may infinite loop due to a
                    different error.
                  </p>
                </li>
              </ol>
              <p>
                The <code>ON CONFLICT conflict_target RETRIEVE</code> feature is
                awesome because:
              </p>
              <ul>
                <li>
                  It's a single point-in-time operation and a single statement.
                  I don't have to issue a new <code>SELECT</code> query that
                  might query state that may have changed since the
                  <code>INSERT</code> attempt.
                </li>
                <li>
                  It's fast: we've already traversed the indices and have access
                  to the row IDs from trying to <code>INSERT</code> so it is a
                  perfect time to pivot to returning results.
                </li>
                <li>
                  It's so handy. Create-or-retrieve is a very common operation.
                  It is a huge win to reduce either the amount of application
                  code I need to write or cut down the complexity of submitted
                  statements.
                </li>
              </ul>
              <p>
                I've seen many StackOverflow threads where people have proposed
                hacks to work around not having this, leveraging:
              </p>
              <ul>
                <li>
                  The existing
                  <code>ON CONFLICT DO UPDATE SET column = column</code> for a
                  no-op mutation but this does lock the row and has other
                  consequences and the overhead of an <code>UPDATE</code>.
                </li>
                <li>
                  A butt ton of Postgres wizardry and CTEs, which again carries
                  overhead.
                </li>
              </ul>
              <p>
                Perhaps there's already a way to do this in Postgres while
                meeting all my desired requirements. I have been unable to find
                it written about on the internet.
              </p>
              <p>
                I don't think <code>RETRIEVE</code> needs to be the syntax.
                Today we have:
              </p>
              <ul>
                <li><code>ON CONFLICT DO NOTHING</code></li>
                <li><code>ON CONFLICT DO UPDATE</code></li>
              </ul>
              <p>
                So it seems nice to keep with the <code>DO _</code> pattern. I
                could see these working:
              </p>
              <ul>
                <li>
                  <code>ON CONFLICT DO SELECT</code>. I hesitate on this one
                  though because <code>SELECT</code> is so overloaded and we
                  wouldn't want to be so feature rich in my opinion.
                </li>
                <li>
                  <code>ON CONFLICT DO RETURN</code>. This one is nice and
                  simple, but <code>DO RETURN</code> is kinda weird in that it's
                  really forcing the <code>DO _</code> convention. Perhaps a
                  simple <code>ON CONFLICT RETURN</code> would be good.
                </li>
              </ul>
              <p>
                It's super odd we don't have this feature yet because it seems
                so easy to implement since we already have
                <code>DO UPDATE</code>. Hopefully it is easy to add because I
                want this really really bad!
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
