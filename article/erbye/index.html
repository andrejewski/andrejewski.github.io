<!DOCTYPE html>
<html lang="en-US">
  <head>
    <title>ERBye</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="Replacing ERB with Eclair to write better HTML in code"
    />
    <meta name="robots" content="index, follow" />

    <link rel="canonical" href="/article/erbye/index.html" />

    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/logo192.png" />

    <meta name="theme-color" content="#178bfb" />

    <meta property="og:title" content="ERBye" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Chris Andrejewski" />
    <meta property="og:url" content="/article/erbye/index.html" />

    <meta property="twitter:card" content="summary" />
    <meta name="twitter:site" content="compooter" />
    <meta name="twitter:title" content="ERBye" />
    <meta
      name="twitter:description"
      content="Replacing ERB with Eclair to write better HTML in code"
    />

    <link rel="stylesheet" href="/stylesheet/highlight-atom-one.css" />
    <style data-styled="true" data-styled-version="5.3.5">
      .kvjZgE {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .kvjZgE {
          color: #5eb6ff;
        }
      } /*!sc*/
      data-styled.g1[id='sc-bczRLJ'] {
        content: 'kvjZgE,';
      } /*!sc*/
      .cUDFKA {
        padding-bottom: 4rem;
      } /*!sc*/
      data-styled.g2[id='sc-gsnTZi'] {
        content: 'cUDFKA,';
      } /*!sc*/
      .ftgBFL {
        background-color: #fff;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ftgBFL {
          background-color: #16202e;
        }
      } /*!sc*/
      data-styled.g3[id='sc-dkzDqf'] {
        content: 'ftgBFL,';
      } /*!sc*/
      .iMPPhc {
        padding: 0px 1rem;
        max-width: 720px;
        margin: 0px auto;
      } /*!sc*/
      data-styled.g4[id='sc-hKMtZM'] {
        content: 'iMPPhc,';
      } /*!sc*/
      .jZkxEC {
        margin: 15px 0em;
      } /*!sc*/
      .jZkxEC:first-child {
        margin-top: 0px;
      } /*!sc*/
      .jZkxEC:last-child {
        margin-bottom: 0px;
      } /*!sc*/
      data-styled.g5[id='sc-eCYdqJ'] {
        content: 'jZkxEC,';
      } /*!sc*/
      .imgLsS {
        padding-top: 3rem;
        margin-bottom: 3rem;
      } /*!sc*/
      data-styled.g6[id='sc-jSMfEi'] {
        content: 'imgLsS,';
      } /*!sc*/
      .kaKiDU {
        font-size: 3rem;
        margin: 0px;
      } /*!sc*/
      @media (max-width: 720px) {
        .kaKiDU {
          font-size: 1.8rem;
        }
      } /*!sc*/
      data-styled.g7[id='sc-gKXOVf'] {
        content: 'kaKiDU,';
      } /*!sc*/
      .xFOWy {
        margin: 0;
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .xFOWy {
          color: #dbe0e7;
        }
      } /*!sc*/
      data-styled.g8[id='sc-iBkjds'] {
        content: 'xFOWy,';
      } /*!sc*/
      .clAnHv {
        display: inline-block;
        font-size: 0.9rem;
        line-height: 1rem;
        background-color: #dcefff;
        color: #151515;
        border-radius: 3px;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0.5rem 0.25rem 0;
        -webkit-text-decoration: none;
        text-decoration: none;
        white-space: nowrap;
      } /*!sc*/
      .clAnHv:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .clAnHv {
          background-color: #2f3d4e;
          color: #c8d2e0;
        }
      } /*!sc*/
      data-styled.g9[id='sc-ftvSup'] {
        content: 'clAnHv,';
      } /*!sc*/
      .iHVwPn {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .iHVwPn:hover span {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .iHVwPn:hover:after {
        opacity: 1;
      } /*!sc*/
      .iHVwPn:after {
        content: 'ðŸ”—';
        padding: 0 0.5rem;
        font-size: 1rem;
        opacity: 0.25;
      } /*!sc*/
      data-styled.g10[id='sc-papXJ'] {
        content: 'iHVwPn,';
      } /*!sc*/
      * {
        box-sizing: border-box;
      } /*!sc*/
      body {
        margin: 0px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica,
          Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
          'Segoe UI Symbol';
        background-color: #eff7fd;
        color: #000;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #0d1117;
          color: #fff;
        }
      } /*!sc*/
      data-styled.g12[id='sc-global-kFwHxP1'] {
        content: 'sc-global-kFwHxP1,';
      } /*!sc*/
      .kylQxs {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: justify;
        -webkit-justify-content: space-between;
        -ms-flex-pack: justify;
        justify-content: space-between;
        -webkit-align-items: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
      } /*!sc*/
      .kylQxs h1 {
        font-size: 1.5rem;
        padding: 1rem 0px;
        margin: 0;
      } /*!sc*/
      .kylQxs h1 a {
        -webkit-text-decoration: none;
        text-decoration: none;
        color: inherit;
      } /*!sc*/
      .kylQxs h1 a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (max-width: 720px) {
        .kylQxs .sc-kDDrLX {
          display: none;
        }
      } /*!sc*/
      data-styled.g14[id='sc-iqcoie'] {
        content: 'kylQxs,';
      } /*!sc*/
      .knOpkX {
        border-top: 2px solid #d7d7d7;
        margin: 4rem 0;
        padding-top: 4rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .knOpkX {
          border-color: #4c545e;
        }
      } /*!sc*/
      data-styled.g53[id='sc-jOrMOR'] {
        content: 'knOpkX,';
      } /*!sc*/
      .cxoMSa h1 > a,
      .cxoMSa h2 > a,
      .cxoMSa h3 > a,
      .cxoMSa h4 > a,
      .cxoMSa h5 > a,
      .cxoMSa h6 > a {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .cxoMSa h1 > a:hover,
      .cxoMSa h2 > a:hover,
      .cxoMSa h3 > a:hover,
      .cxoMSa h4 > a:hover,
      .cxoMSa h5 > a:hover,
      .cxoMSa h6 > a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .cxoMSa p,
      .cxoMSa li {
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .cxoMSa p,
        .cxoMSa li {
          color: #dbe0e7;
        }
      } /*!sc*/
      .cxoMSa a {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .cxoMSa a {
          color: #5eb6ff;
        }
      } /*!sc*/
      .cxoMSa ul {
        padding-left: 1rem;
      } /*!sc*/
      .cxoMSa code {
        font-family: Monaco, monospace;
      } /*!sc*/
      .cxoMSa h1 code,
      .cxoMSa h2 code,
      .cxoMSa h3 code,
      .cxoMSa h4 code,
      .cxoMSa h5 code,
      .cxoMSa h6 code,
      .cxoMSa li code,
      .cxoMSa p code {
        font-size: 0.9em;
        padding: 0 0.25em;
        border-radius: 3px;
        background-color: #eff7fd;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .cxoMSa h1 code,
        .cxoMSa h2 code,
        .cxoMSa h3 code,
        .cxoMSa h4 code,
        .cxoMSa h5 code,
        .cxoMSa h6 code,
        .cxoMSa li code,
        .cxoMSa p code {
          background-color: #2b3644;
        }
      } /*!sc*/
      .cxoMSa pre {
        background-color: #eff7fd;
        padding: 0.5rem 0.75rem;
        overflow-x: scroll;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .cxoMSa pre {
          background-color: #2b3645;
        }
      } /*!sc*/
      .cxoMSa img {
        display: block;
        max-width: 100%;
        max-height: 520px;
        font-size: 0;
        margin: 0px auto;
        padding: 0px;
      } /*!sc*/
      .cxoMSa video {
        display: block;
        margin: 1rem auto;
      } /*!sc*/
      .cxoMSa figure {
        text-align: center;
        margin: 20px 0px;
      } /*!sc*/
      .cxoMSa figure img {
        display: block;
        max-width: 90vw;
        margin: 0px auto;
      } /*!sc*/
      .cxoMSa figure figcaption {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px auto;
      } /*!sc*/
      .cxoMSa .cali-collage {
        padding: 20px 0px;
        text-align: center;
      } /*!sc*/
      .cxoMSa .cali-collage img {
        display: inline-block;
        margin: 10px;
        max-width: 95vw;
        vertical-align: middle;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      } /*!sc*/
      data-styled.g54[id='sc-dPyBCJ'] {
        content: 'cxoMSa,';
      } /*!sc*/
      .IPkLw {
        text-align: center;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .IPkLw {
          color: #dbe0e7;
        }
      } /*!sc*/
      .IPkLw h3 {
        margin: 0.5em 0;
      } /*!sc*/
      .IPkLw p {
        margin: 0;
      } /*!sc*/
      data-styled.g55[id='sc-bBXxYQ'] {
        content: 'IPkLw,';
      } /*!sc*/
    </style>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-G3SKTPFTEZ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag('js', new Date())
      gtag('config', 'G-G3SKTPFTEZ')
    </script>
  </head>
  <body>
    <div class="sc-dkzDqf ftgBFL">
      <div class="sc-gsnTZi cUDFKA">
        <div class="sc-dkzDqf ftgBFL">
          <div class="sc-hKMtZM iMPPhc">
            <nav class="sc-iqcoie kylQxs">
              <h1><a href="/">Chris Andrejewski</a></h1>
            </nav>
          </div>
        </div>
        <div class="sc-hKMtZM iMPPhc">
          <div class="sc-jSMfEi imgLsS">
            <p class="sc-iBkjds xFOWy">
              <a href="/writing" class="sc-ftvSup clAnHv">Articles</a
              ><a href="/category/ruby/index.html" class="sc-ftvSup clAnHv"
                >Ruby programming</a
              ><a
                href="/category/engineering/index.html"
                class="sc-ftvSup clAnHv"
                >Engineering</a
              >
            </p>
            <h1 class="sc-gKXOVf kaKiDU">
              <a href="#" class="sc-papXJ iHVwPn"><span>ERBye</span></a>
            </h1>
            <p class="sc-iBkjds xFOWy">
              Replacing ERB with Eclair to write better HTML in code
            </p>
          </div>
          <div class="sc-eCYdqJ jZkxEC">
            <div class="sc-dPyBCJ cxoMSa">
              <p>
                I'm an accidental expert in ERB. I wrote a whole component
                system on top of ERB when I was building Stripe's internal email
                API. This was more than three years ago.
              </p>
              <p>
                That component system is quite complicated and includes the
                capability to type-check ERBs using Sorbet. We do this by
                compiling each ERB file into Ruby code, slap some code-generated
                <code>sig</code>'s on the template function, and run the
                type-checker. This is fairly straightforward but won't land
                <em>inside</em> Sorbet due to much higher priorities (rightfully
                so).
              </p>
              <p>
                That is the worst thing about ERB: no one cares enough. It's
                akin to writing code in Java. No one writing in ERB is trying
                their best because they know the medium itself isn't one that is
                attune to doing their best work. In this sense, writing ERB is
                an uphill battle to start. No one considers it real code.
              </p>
              <p>
                ERB does itself no favor by also being quite insecure by
                default. A key aspect of the component system was eliminating
                XSS vulnerabilities. Because stock ERB is HTML-unaware, it has
                no syntax for safely escaping untrusted user input.
              </p>
              <p>
                For example, if <code>user_name</code> were set to
                <code>&quot;&lt;script&gt;evil()&lt;/script&gt;&quot;</code> in
                this template:
              </p>
              <pre><code class="language-erb"><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Hello, &lt;%=</span><span class="language-ruby"> user_name </span><span class="language-xml">%&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</span></code></pre>
              <p>The output is:</p>
              <pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>
  Hello,
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>
    evil()
  <span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
</code></pre>
              <p>
                This gap led to a proliferation of ERB-likes that offer
                additional safeguards. Before we aligned on the component system
                there were competing ERB syntaxes and libraries in the codebase.
                This made detection of potential XSS vulnerabilities basically
                impossible. Fixing this library problem was one of my more
                interesting security side-quests.
              </p>
              <p>
                The component system built atop ERB has gone on to see great
                adoption. With over 400 components and 2000 distinct email types
                it's become a staple developer experience. However, at the end
                of the day despite all the effort I put into it, it's still
                subpar.
              </p>
              <p>
                I knew what the better solution was three years ago but was
                worried the approach would be too radical to get consensus. And
                a migration from the old wild-west ERBs to a saner ERB system
                was a lighter move in a better direction. I don't look back with
                regret, just with curiosity about what could have been.
              </p>
              <p>
                The better authoring experience is React's JSX code-based
                component system. There's a lot of flashy, complex stuff in
                React but JSX itself is great for sure. ERB templates are a
                second-class citizen, but JSX <em>is</em> code. Developers grok
                this and write much better code accordingly. It's generating
                HTML just like ERB but somehow it feels more enduring and
                reasonable to take the time to author good code.
              </p>
              <p>
                This past week I
                <a href="/making-my-first-ruby-gem">wrote a gem</a> to capture
                this better authoring experience for Ruby. The gem is named
                <a href="https://github.com/andrejewski/eclair">Eclair</a>. I
                chose this name because eclair is a dessert like sorbet, eclair
                starts with E like ERB, and &quot;eclair&quot; sounds like
                &quot;declare&quot; as in the declarative nature of JSX.
              </p>
              <p>The above example but using Eclair:</p>
              <pre><code class="language-rb">html = Eclair.render(
   Eclair::Html.p({}, [<span class="hljs-string">&quot;Hello, &quot;</span>, user_name])
)
</code></pre>
              <p>
                The XSS issues are accounted for. If you wanted to allow raw
                HTML into Eclair you would have to write it with much more
                intent:
              </p>
              <pre><code class="language-rb">html = Eclair.render(
   Eclair::Html.p(
      {},
      [
         <span class="hljs-string">&quot;Hello, &quot;</span>,
         <span class="hljs-title class_">Eclair::Element::DangerousUnescapedHtml</span>.new(
            <span class="hljs-symbol">html:</span> user_name
         )
      ]
   )
)
</code></pre>
              <p>
                That one will be caught in code review or by linters with ease.
              </p>
              <p>
                I'm also happy with how boilerplate-less Eclair is thanks to
                Ruby's built-in <code>yield_self</code> method which removes the
                namespace verbosity:
              </p>
              <pre><code class="language-rb"><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_footer</span>
   Eclair::Html.yield_self <span class="hljs-keyword">do</span> |<span class="hljs-params">h</span>|
      h.footer({}, [
         h.ul({}, [
            h.li({}, [h.a({<span class="hljs-symbol">href:</span> <span class="hljs-string">&#x27;/&#x27;</span>}, [<span class="hljs-string">&#x27;Home&#x27;</span>])]),
            h.li({}, [h.a({<span class="hljs-symbol">href:</span> <span class="hljs-string">&#x27;/about&#x27;</span>}, [<span class="hljs-string">&#x27;About&#x27;</span>])]),
         ])
      ])
   <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>

html = Eclair.render(make_footer)
<span class="hljs-comment">#=&gt; &#x27;&lt;footer&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;â€¦&#x27;</span>
</code></pre>
              <p>
                It's a small library with Sorbet types, but addresses all the
                developer experience shortcomings of ERB. So much so that it's
                time for me to say goodbye to ERB, at least where I can.
              </p>
              <p>
                Try
                <a href="https://github.com/andrejewski/eclair">Eclair</a> for
                yourself and thanks for reading!
              </p>
            </div>
          </div>
          <div class="sc-eCYdqJ jZkxEC">
            <p class="sc-iBkjds xFOWy">
              <small
                ><time
                  datetime="2023-10-31T00:00:00.000Z"
                  title="2023-10-31T00:00:00.000Z"
                  >Published 10/31/2023</time
                ></small
              >
            </p>
          </div>
          <div class="sc-jOrMOR knOpkX">
            <div class="sc-bBXxYQ IPkLw">
              <h3>Subscribe for new articles</h3>
              <iframe
                width="300"
                height="35"
                frameborder="off"
                scrolling="off"
                src="https://newsletter.jew.ski/frame/subscribe"
              ></iframe>
              <p>
                <small
                  >Or add the
                  <a href="/writing/feed.atom.xml" class="sc-bczRLJ kvjZgE"
                    >Atom feed</a
                  >
                  to your feed reader.</small
                >
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
