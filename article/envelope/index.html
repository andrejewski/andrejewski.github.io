<!doctype html>
<html lang="en-US">
  <head>
    <title>Envelopes</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="Cool properties of envelopes and apply them to program state"
    />
    <meta name="robots" content="index, follow" />

    <link rel="canonical" href="https://jew.ski/article/envelope/index.html" />

    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/logo192.png" />

    <meta name="theme-color" content="#178bfb" />

    <meta property="og:title" content="Envelopes" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Chris Andrejewski" />
    <meta property="og:url" content="/article/envelope/index.html" />

    <meta property="twitter:card" content="summary" />
    <meta name="twitter:site" content="compooter" />
    <meta name="twitter:title" content="Envelopes" />
    <meta
      name="twitter:description"
      content="Cool properties of envelopes and apply them to program state"
    />

    <link rel="stylesheet" href="/stylesheet/highlight-atom-one.css" />
    <style data-styled="true" data-styled-version="5.3.11">
      .rzRBI {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .rzRBI {
          color: #5eb6ff;
        }
      } /*!sc*/
      data-styled.g1[id='sc-aXZVg'] {
        content: 'rzRBI,';
      } /*!sc*/
      .juOMfq {
        padding-bottom: 4rem;
      } /*!sc*/
      data-styled.g2[id='sc-gEvEer'] {
        content: 'juOMfq,';
      } /*!sc*/
      .qTPpo {
        background-color: #fff;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .qTPpo {
          background-color: #16202e;
        }
      } /*!sc*/
      data-styled.g3[id='sc-eqUAAy'] {
        content: 'qTPpo,';
      } /*!sc*/
      .jTutFS {
        padding: 0px 1rem;
        max-width: 720px;
        margin: 0px auto;
      } /*!sc*/
      data-styled.g4[id='sc-fqkvVR'] {
        content: 'jTutFS,';
      } /*!sc*/
      .efqZme {
        margin: 15px 0em;
      } /*!sc*/
      .efqZme:first-child {
        margin-top: 0px;
      } /*!sc*/
      .efqZme:last-child {
        margin-bottom: 0px;
      } /*!sc*/
      data-styled.g5[id='sc-dcJsrY'] {
        content: 'efqZme,';
      } /*!sc*/
      .khRKiz {
        padding-top: 3rem;
        margin-bottom: 3rem;
      } /*!sc*/
      data-styled.g6[id='sc-iGgWBj'] {
        content: 'khRKiz,';
      } /*!sc*/
      .fmIvPa {
        font-size: 3rem;
        margin: 0px;
      } /*!sc*/
      @media (max-width: 720px) {
        .fmIvPa {
          font-size: 1.8rem;
        }
      } /*!sc*/
      data-styled.g7[id='sc-gsFSXq'] {
        content: 'fmIvPa,';
      } /*!sc*/
      .cFLcRl {
        margin: 0;
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .cFLcRl {
          color: #dbe0e7;
        }
      } /*!sc*/
      data-styled.g8[id='sc-kAyceB'] {
        content: 'cFLcRl,';
      } /*!sc*/
      .dpyEem {
        display: inline-block;
        font-size: 0.9rem;
        line-height: 1rem;
        background-color: #dcefff;
        color: #151515;
        border-radius: 3px;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0.5rem 0.25rem 0;
        -webkit-text-decoration: none;
        text-decoration: none;
        white-space: nowrap;
      } /*!sc*/
      .dpyEem:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .dpyEem {
          background-color: #2f3d4e;
          color: #c8d2e0;
        }
      } /*!sc*/
      data-styled.g9[id='sc-imWYAI'] {
        content: 'dpyEem,';
      } /*!sc*/
      .ypGOR {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .ypGOR:hover span {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .ypGOR:hover:after {
        opacity: 1;
      } /*!sc*/
      .ypGOR:after {
        content: 'ðŸ”—';
        padding: 0 0.5rem;
        font-size: 1rem;
        opacity: 0.25;
      } /*!sc*/
      data-styled.g10[id='sc-jXbUNg'] {
        content: 'ypGOR,';
      } /*!sc*/
      .jXVzSo {
        padding: 1rem;
        margin: 3rem 0;
        background-color: #eef8ff;
        color: #4a8dc8;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .jXVzSo {
          background-color: #2a3d55;
          color: #95afd1;
        }
      } /*!sc*/
      .jXVzSo label {
        text-transform: uppercase;
        font-weight: bold;
        font-size: 0.85rem;
        color: #08273f;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .jXVzSo label {
          color: #dde0e3;
        }
      } /*!sc*/
      .jXVzSo .sc-kAyceB {
        color: #153248;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .jXVzSo .sc-kAyceB {
          color: #d0e4ff;
        }
      } /*!sc*/
      .jXVzSo ul {
        margin: 0.5rem 0;
        padding: 0;
        padding-left: 1rem;
      } /*!sc*/
      .jXVzSo a {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .jXVzSo a {
          color: #5eb6ff;
        }
      } /*!sc*/
      .jXVzSo a code {
        font-family: Monaco, monospace;
        font-size: 0.9rem;
        padding: 0 0.25rem;
        border-radius: 3px;
        background-color: #b9dbf5;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .jXVzSo a code {
          background-color: #354e6d;
        }
      } /*!sc*/
      data-styled.g11[id='sc-dhKdcB'] {
        content: 'jXVzSo,';
      } /*!sc*/
      * {
        box-sizing: border-box;
      } /*!sc*/
      body {
        margin: 0px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica,
          Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
          'Segoe UI Symbol';
        background-color: #eff7fd;
        color: #000;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #0d1117;
          color: #fff;
        }
      } /*!sc*/
      data-styled.g12[id='sc-global-kFwHxP1'] {
        content: 'sc-global-kFwHxP1,';
      } /*!sc*/
      .denQqw {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: justify;
        -webkit-justify-content: space-between;
        -ms-flex-pack: justify;
        justify-content: space-between;
        -webkit-align-items: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
      } /*!sc*/
      .denQqw h1 {
        font-size: 1.5rem;
        padding: 1rem 0px;
        margin: 0;
      } /*!sc*/
      .denQqw h1 a {
        -webkit-text-decoration: none;
        text-decoration: none;
        color: inherit;
      } /*!sc*/
      .denQqw h1 a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (max-width: 720px) {
        .denQqw .sc-kpDqfm {
          display: none;
        }
      } /*!sc*/
      data-styled.g14[id='sc-dAlyuH'] {
        content: 'denQqw,';
      } /*!sc*/
      .frqlqR {
        border-top: 2px solid #d7d7d7;
        margin: 4rem 0;
        padding-top: 4rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .frqlqR {
          border-color: #4c545e;
        }
      } /*!sc*/
      data-styled.g54[id='sc-fXSgeo'] {
        content: 'frqlqR,';
      } /*!sc*/
      .eRjDjS h1 > a,
      .eRjDjS h2 > a,
      .eRjDjS h3 > a,
      .eRjDjS h4 > a,
      .eRjDjS h5 > a,
      .eRjDjS h6 > a {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .eRjDjS h1 > a:hover,
      .eRjDjS h2 > a:hover,
      .eRjDjS h3 > a:hover,
      .eRjDjS h4 > a:hover,
      .eRjDjS h5 > a:hover,
      .eRjDjS h6 > a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .eRjDjS p,
      .eRjDjS li {
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .eRjDjS p,
        .eRjDjS li {
          color: #dbe0e7;
        }
      } /*!sc*/
      .eRjDjS a {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .eRjDjS a {
          color: #5eb6ff;
        }
      } /*!sc*/
      .eRjDjS ul {
        padding-left: 1rem;
      } /*!sc*/
      .eRjDjS code {
        font-family: Monaco, monospace;
      } /*!sc*/
      .eRjDjS h1 code,
      .eRjDjS h2 code,
      .eRjDjS h3 code,
      .eRjDjS h4 code,
      .eRjDjS h5 code,
      .eRjDjS h6 code,
      .eRjDjS li code,
      .eRjDjS p code {
        font-size: 0.9em;
        padding: 0 0.25em;
        border-radius: 3px;
        background-color: #eff7fd;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .eRjDjS h1 code,
        .eRjDjS h2 code,
        .eRjDjS h3 code,
        .eRjDjS h4 code,
        .eRjDjS h5 code,
        .eRjDjS h6 code,
        .eRjDjS li code,
        .eRjDjS p code {
          background-color: #2b3644;
        }
      } /*!sc*/
      .eRjDjS pre {
        background-color: #eff7fd;
        padding: 0.5rem 0.75rem;
        overflow-x: scroll;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .eRjDjS pre {
          background-color: #2b3645;
        }
      } /*!sc*/
      .eRjDjS img {
        display: block;
        max-width: 100%;
        max-height: 520px;
        font-size: 0;
        margin: 0px auto;
        padding: 0px;
      } /*!sc*/
      .eRjDjS video {
        display: block;
        margin: 1rem auto;
      } /*!sc*/
      .eRjDjS figure {
        text-align: center;
        margin: 20px 0px;
      } /*!sc*/
      .eRjDjS figure img {
        display: block;
        max-width: 90vw;
        margin: 0px auto;
      } /*!sc*/
      .eRjDjS figure figcaption {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px auto;
      } /*!sc*/
      .eRjDjS .cali-collage {
        padding: 20px 0px;
        text-align: center;
      } /*!sc*/
      .eRjDjS .cali-collage img {
        display: inline-block;
        margin: 10px;
        max-width: 95vw;
        vertical-align: middle;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      } /*!sc*/
      data-styled.g55[id='sc-JrDLc'] {
        content: 'eRjDjS,';
      } /*!sc*/
      .jACQif {
        text-align: center;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .jACQif {
          color: #dbe0e7;
        }
      } /*!sc*/
      .jACQif h3 {
        margin: 0.5em 0;
      } /*!sc*/
      .jACQif p {
        margin: 0;
      } /*!sc*/
      data-styled.g56[id='sc-fjvvzt'] {
        content: 'jACQif,';
      } /*!sc*/
    </style>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-G3SKTPFTEZ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag('js', new Date())
      gtag('config', 'G-G3SKTPFTEZ')
    </script>
  </head>
  <body>
    <div class="sc-eqUAAy qTPpo">
      <div class="sc-gEvEer juOMfq">
        <div class="sc-eqUAAy qTPpo">
          <div class="sc-fqkvVR jTutFS">
            <nav class="sc-dAlyuH denQqw">
              <h1><a href="/">Chris Andrejewski</a></h1>
            </nav>
          </div>
        </div>
        <div class="sc-fqkvVR jTutFS">
          <div class="sc-iGgWBj khRKiz">
            <p class="sc-kAyceB cFLcRl">
              <a href="/writing" class="sc-imWYAI dpyEem">Articles</a
              ><a
                href="/category/engineering/index.html"
                class="sc-imWYAI dpyEem"
                >Engineering</a
              >
            </p>
            <h1 class="sc-gsFSXq fmIvPa">
              <a href="#" class="sc-jXbUNg ypGOR"><span>Envelopes</span></a>
            </h1>
            <p class="sc-kAyceB cFLcRl">
              Cool properties of envelopes and apply them to program state
            </p>
          </div>
          <div class="sc-dhKdcB jXVzSo">
            <p class="sc-kAyceB cFLcRl"><label>Table of contents</label></p>
            <div>
              <ul>
                <li><a href="#envelope-properties">Envelope properties</a></li>
                <li><a href="#system-properties">System properties</a></li>
                <li><a href="#application-state">Application state</a></li>
                <li><a href="#further-reading">Further reading</a></li>
              </ul>
            </div>
          </div>
          <div class="sc-dcJsrY efqZme">
            <div class="sc-JrDLc eRjDjS">
              <p>
                Envelopes are an interesting concept. Long-distance physical
                mail is a good example:
              </p>
              <p>
                Someone writes a note and puts it an envelope marked with a
                recipient. That envelope is picked up by a mailman responsible
                for the sender's block. That mailman takes their bag of
                collected envelopes to their post office. That post office
                assigns the envelope to the correct outgoing bin. That bin is
                put into an airplane.
              </p>
              <p>
                The plane arrives and someone takes the bin to the post office.
                The post office distributes the bin to the mail bags. Some
                mailman distributes their bag to the recipient's block. The
                recipient gets the envelope and opens it for the note.
              </p>
              <h1 id="envelope-properties">
                <a href="#envelope-properties">Envelope properties</a>
              </h1>
              <p>
                Thinking abstractly, there are quite a few &quot;envelopes&quot;
                in this process. The envelope, bag, bin, airplane. Even the note
                if the value is what is written on it. These envelopes range in
                complexity, but:
              </p>
              <ul>
                <li>Contain things</li>
                <li>Have information other than their content</li>
                <li>Can be opened and inspected (disregarding legality)</li>
                <li>
                  Do not restrict what their contents are (excluding size)
                </li>
                <li>Do not restrict how they are contained</li>
                <li>Do not do anything on their own</li>
              </ul>
              <p>
                We see a very similar process in computer networks. Frames,
                packets, and what not serve as envelopes for routing
                information.
              </p>
              <p>
                The properties of envelopes are pretty cool. An envelope
                implemented in code would:
              </p>
              <ul>
                <li>
                  Be generic, like <code>Envelope&lt;T&gt;</code> where
                  <code>T</code> could be anything or nothing
                </li>
                <li>Express some information in itself</li>
              </ul>
              <p>
                With a definition like <code>Envelope&lt;T&gt;</code> an
                envelope could contain another.
              </p>
              <p>
                An envelope would also be side-effect free and as close to data
                as the language would allow as envelopes are inert.
              </p>
              <p>
                Envelopes would be best built so they are inspect-able at each
                level just as a bin can be looked in and an envelope can be
                opened.
              </p>
              <h1 id="system-properties">
                <a href="#system-properties">System properties</a>
              </h1>
              <p>
                There is another value in envelopes: decoupled responsibility.
                The sender, receiver, mailmen, and pilots work in their own
                domains. Even though they are facilitating the same
                communication, they are only acting in the context of their own
                envelopes. This is a tree of behaviors interacting with
                messages.
              </p>
              <p>
                Imagine we wanted to inspect every piece of mail, censor certain
                pieces of mail, or just block all mail between the sender and
                recipient. We could do these things at the plane-level as all
                letters flow through that point. If the sender and recipient
                were in the same city we could intervene at the post office
                level. If the sender was the receiver, everyone in the tree
                could intervene.
              </p>
              <p>
                Imagine the bins were overflowing and it required two planes, or
                there was bad weather and there were no planes, or maybe a new
                post office hub combined the original post office with others.
                The sender and recipient do not care about changes in the tree.
              </p>
              <h1 id="application-state">
                <a href="#application-state">Application state</a>
              </h1>
              <p>
                Apply these features to the idea of application state.
                Application state is a tree structure wherein there are global
                and local states. We can communicate up and down this structure.
                We have choke-points for messages to be observed or manipulated.
                We have localized state relative to what program is handling
                which envelopes. We can grow out the state without breaking
                existing communications.
              </p>
              <p>
                The decoupling means these layers would be simple to test. We
                could give a layer an empty envelope and test if it was routed
                correctly. If envelopes are just plain data, there is nothing to
                mock; tests are very small, input-output.
              </p>
              <p>These are very powerful characteristics.</p>
              <h1 id="further-reading">
                <a href="#further-reading">Further reading</a>
              </h1>
              <p>
                There are implementations of this envelope architecture. The Elm
                Architecture (TEA) is built around these communication
                constructs. The
                <a href="http://elm-lang.org/">programming language Elm</a> and
                <a href="https://jew.ski/raj/">JavaScript framework Raj</a> are
                good things to try to really gain an in depth understanding.
              </p>
              <p>
                I created Raj based on TEA and have grown to appreciate this
                power and simplicity as I have built more apps and libraries
                leveraging it. I do recommend Elm, but Raj better highlights the
                full extent of these patterns because of JavaScript's dynamic
                and generic nature.
              </p>
            </div>
          </div>
          <div class="sc-dcJsrY efqZme">
            <p class="sc-kAyceB cFLcRl">
              <small
                ><time
                  datetime="2018-06-09T00:00:00.000Z"
                  title="2018-06-09T00:00:00.000Z"
                  >Published 6/9/2018</time
                ></small
              >
            </p>
          </div>
          <div
            class="sc-fXSgeo frqlqR newsletter-container"
            data-frame-src="https://newsletter.jew.ski/frame/subscribe"
          >
            <div class="sc-fjvvzt jACQif">
              <h3>Subscribe for new articles</h3>
              <div class="newsletter-form"></div>
              <p>
                <small
                  >Or add the
                  <a href="/writing/feed.atom.xml" class="sc-aXZVg rzRBI"
                    >Atom feed</a
                  >
                  to your feed reader.</small
                >
              </p>
            </div>
            <script src="https://newsletter-js.jew.ski/v1/subscribe-embed.js"></script>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
