<!DOCTYPE html>
<html>
  <head>
    <title>Layering</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="Layering is a tool in the code quality tool belt to help with dividing code into easier to understand units."
    />
    <meta name="robots" content="noindex, nofollow" />

    <link rel="canonical" href="/article/layering/index.html" />

    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/logo192.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#178bfb" />

    <meta property="og:title" content="Layering" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Chris Andrejewski" />
    <meta property="og:url" content="/article/layering/index.html" />

    <meta property="twitter:card" content="summary" />
    <meta name="twitter:site" content="compooter" />
    <meta name="twitter:title" content="Layering" />
    <meta
      name="twitter:description"
      content="Layering is a tool in the code quality tool belt to help with dividing code into easier to understand units."
    />

    <link rel="stylesheet" href="/stylesheet/highlight-atom-one.css" />
    <style data-styled="true" data-styled-version="5.3.5">
      .cUDFKA {
        padding-bottom: 4rem;
      } /*!sc*/
      data-styled.g2[id='sc-gsnTZi'] {
        content: 'cUDFKA,';
      } /*!sc*/
      .ftgBFL {
        background-color: #fff;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ftgBFL {
          background-color: #16202e;
        }
      } /*!sc*/
      data-styled.g3[id='sc-dkzDqf'] {
        content: 'ftgBFL,';
      } /*!sc*/
      .iMPPhc {
        padding: 0px 1rem;
        max-width: 720px;
        margin: 0px auto;
      } /*!sc*/
      data-styled.g4[id='sc-hKMtZM'] {
        content: 'iMPPhc,';
      } /*!sc*/
      .jZkxEC {
        margin: 15px 0em;
      } /*!sc*/
      .jZkxEC:first-child {
        margin-top: 0px;
      } /*!sc*/
      .jZkxEC:last-child {
        margin-bottom: 0px;
      } /*!sc*/
      data-styled.g5[id='sc-eCYdqJ'] {
        content: 'jZkxEC,';
      } /*!sc*/
      .eBtA-dh {
        margin: 3rem 0;
      } /*!sc*/
      data-styled.g6[id='sc-jSMfEi'] {
        content: 'eBtA-dh,';
      } /*!sc*/
      .kaKiDU {
        font-size: 3rem;
        margin: 0px;
      } /*!sc*/
      @media (max-width: 720px) {
        .kaKiDU {
          font-size: 1.8rem;
        }
      } /*!sc*/
      data-styled.g7[id='sc-gKXOVf'] {
        content: 'kaKiDU,';
      } /*!sc*/
      .xFOWy {
        margin: 0;
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .xFOWy {
          color: #dbe0e7;
        }
      } /*!sc*/
      data-styled.g8[id='sc-iBkjds'] {
        content: 'xFOWy,';
      } /*!sc*/
      .hmuBWy {
        display: inline-block;
        font-size: 0.9rem;
        line-height: 1rem;
        background-color: #9ed2f9;
        color: #151515;
        border-radius: 3px;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0.5rem 0.25rem 0;
        -webkit-text-decoration: none;
        text-decoration: none;
        white-space: nowrap;
      } /*!sc*/
      .hmuBWy:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .hmuBWy {
          background-color: #2f3d4e;
          color: #c8d2e0;
        }
      } /*!sc*/
      data-styled.g9[id='sc-ftvSup'] {
        content: 'hmuBWy,';
      } /*!sc*/
      .iHVwPn {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .iHVwPn:hover span {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .iHVwPn:hover:after {
        opacity: 1;
      } /*!sc*/
      .iHVwPn:after {
        content: 'ðŸ”—';
        padding: 0 0.5rem;
        font-size: 1rem;
        opacity: 0.25;
      } /*!sc*/
      data-styled.g10[id='sc-papXJ'] {
        content: 'iHVwPn,';
      } /*!sc*/
      .fPhkML {
        padding: 1rem;
        margin: 3rem 0;
        background-color: #daefff;
        color: #769fbe;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .fPhkML {
          background-color: #2a3d55;
          color: #95afd1;
        }
      } /*!sc*/
      .fPhkML .sc-iBkjds {
        color: #153248;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .fPhkML .sc-iBkjds {
          color: #d0e4ff;
        }
      } /*!sc*/
      .fPhkML ul {
        margin: 0.5rem 0;
        padding: 0;
        padding-left: 1rem;
      } /*!sc*/
      .fPhkML a {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .fPhkML a {
          color: #5eb6ff;
        }
      } /*!sc*/
      .fPhkML a code {
        font-family: Monaco, monospace;
        font-size: 0.9rem;
        padding: 0 0.25rem;
        border-radius: 3px;
        background-color: #b9dbf5;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .fPhkML a code {
          background-color: #354e6d;
        }
      } /*!sc*/
      data-styled.g11[id='sc-jqUVSM'] {
        content: 'fPhkML,';
      } /*!sc*/
      * {
        box-sizing: border-box;
      } /*!sc*/
      body {
        margin: 0px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica,
          Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
          'Segoe UI Symbol';
        background-color: #eff7fd;
        color: #000;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #0d1117;
          color: #fff;
        }
      } /*!sc*/
      data-styled.g12[id='sc-global-kFwHxP1'] {
        content: 'sc-global-kFwHxP1,';
      } /*!sc*/
      .kylQxs {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: justify;
        -webkit-justify-content: space-between;
        -ms-flex-pack: justify;
        justify-content: space-between;
        -webkit-align-items: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
      } /*!sc*/
      .kylQxs h1 {
        font-size: 1.5rem;
        padding: 1rem 0px;
        margin: 0;
      } /*!sc*/
      .kylQxs h1 a {
        -webkit-text-decoration: none;
        text-decoration: none;
        color: inherit;
      } /*!sc*/
      .kylQxs h1 a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (max-width: 720px) {
        .kylQxs .sc-kDDrLX {
          display: none;
        }
      } /*!sc*/
      data-styled.g14[id='sc-iqcoie'] {
        content: 'kylQxs,';
      } /*!sc*/
      .ismAZz h1 > a,
      .ismAZz h2 > a,
      .ismAZz h3 > a,
      .ismAZz h4 > a,
      .ismAZz h5 > a,
      .ismAZz h6 > a {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .ismAZz h1 > a:hover,
      .ismAZz h2 > a:hover,
      .ismAZz h3 > a:hover,
      .ismAZz h4 > a:hover,
      .ismAZz h5 > a:hover,
      .ismAZz h6 > a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .ismAZz p,
      .ismAZz li {
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ismAZz p,
        .ismAZz li {
          color: #dbe0e7;
        }
      } /*!sc*/
      .ismAZz a {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ismAZz a {
          color: #5eb6ff;
        }
      } /*!sc*/
      .ismAZz ul {
        padding-left: 1rem;
      } /*!sc*/
      .ismAZz code {
        font-family: Monaco, monospace;
      } /*!sc*/
      .ismAZz h1 code,
      .ismAZz h2 code,
      .ismAZz h3 code,
      .ismAZz h4 code,
      .ismAZz h5 code,
      .ismAZz h6 code,
      .ismAZz li code,
      .ismAZz p code {
        font-size: 0.9em;
        padding: 0 0.25em;
        border-radius: 3px;
        background-color: #eff7fd;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ismAZz h1 code,
        .ismAZz h2 code,
        .ismAZz h3 code,
        .ismAZz h4 code,
        .ismAZz h5 code,
        .ismAZz h6 code,
        .ismAZz li code,
        .ismAZz p code {
          background-color: #2b3644;
        }
      } /*!sc*/
      .ismAZz pre {
        background-color: #eff7fd;
        padding: 0.5rem 0.75rem;
        overflow-x: scroll;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ismAZz pre {
          background-color: #2b3645;
        }
      } /*!sc*/
      .ismAZz img {
        display: block;
        max-width: 100%;
        max-height: 520px;
        font-size: 0;
        margin: 0px auto;
        padding: 0px;
      } /*!sc*/
      .ismAZz video {
        display: block;
        margin: 1rem auto;
      } /*!sc*/
      .ismAZz figure {
        text-align: center;
        margin: 20px 0px;
      } /*!sc*/
      .ismAZz figure img {
        display: block;
        max-width: 90vw;
        margin: 0px auto;
      } /*!sc*/
      .ismAZz figure figcaption {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px auto;
      } /*!sc*/
      .ismAZz .cali-collage {
        padding: 20px 0px;
        text-align: center;
      } /*!sc*/
      .ismAZz .cali-collage img {
        display: inline-block;
        margin: 10px;
        max-width: 95vw;
        vertical-align: middle;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      } /*!sc*/
      data-styled.g15[id='sc-crXcEl'] {
        content: 'ismAZz,';
      } /*!sc*/
    </style>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-G3SKTPFTEZ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag('js', new Date())
      gtag('config', 'G-G3SKTPFTEZ')
    </script>
  </head>
  <body>
    <div class="sc-dkzDqf ftgBFL">
      <div class="sc-gsnTZi cUDFKA">
        <div class="sc-dkzDqf ftgBFL">
          <div class="sc-hKMtZM iMPPhc">
            <nav class="sc-iqcoie kylQxs">
              <h1><a href="/">Chris Andrejewski</a></h1>
            </nav>
          </div>
        </div>
        <div class="sc-hKMtZM iMPPhc">
          <div class="sc-jSMfEi eBtA-dh">
            <p class="sc-iBkjds xFOWy">
              <a
                href="/category/code-quality/index.html"
                class="sc-ftvSup hmuBWy"
                >Code quality principles</a
              ><a
                href="/category/engineering/index.html"
                class="sc-ftvSup hmuBWy"
                >Engineering</a
              >
            </p>
            <h1 class="sc-gKXOVf kaKiDU">
              <a href="#" class="sc-papXJ iHVwPn"><span>Layering</span></a>
            </h1>
            <p class="sc-iBkjds xFOWy">
              Layering is a tool in the code quality tool belt to help with
              dividing code into easier to understand units.
            </p>
          </div>
          <div class="sc-jqUVSM fPhkML">
            <p class="sc-iBkjds xFOWy">Table of contents</p>
            <div>
              <ul>
                <li>
                  <a href="#approaches">Approaches</a>
                  <ul>
                    <li><a href="#example-security">Example: security</a></li>
                  </ul>
                </li>
                <li><a href="#evolution">Evolution</a></li>
              </ul>
            </div>
          </div>
          <div class="sc-eCYdqJ jZkxEC">
            <div class="sc-crXcEl ismAZz">
              <p>
                It helps to divide code into easy to understand units. Layering
                is a tool in the code quality tool belt to help with this.
                Essentially you drive wedges between the pieces of a larger
                problem space. These small problems are layers. Each layer has a
                unique characteristic and sits in an ordered list by that
                characteristic.
              </p>
              <p>
                For example, in computer networking layers are employed readily
                in protocol stacks. The
                <a href="https://en.wikipedia.org/wiki/Internet_protocol_suite"
                  >Internet protocol suite</a
                >
                (commonly IP/TCP) is illustrated with layers:
              </p>
              <p>
                <img
                  src="/images/layering/network-layering.png"
                  alt="Layering for computer networks following the IP/TCP model."
                />
              </p>
              <p>
                At the top, we are furthest removed from the hardware and
                extending down we get closer and closer to the raw metal. Each
                layer provides functionality which the lower layers to not
                provide which is useful to the layers above it.
              </p>
              <p>
                Layering as a problem modeling technique is broadly applicable.
                For code quality, layering aims to help with:
              </p>
              <ul>
                <li>Organizing larger problems in a logical way</li>
                <li>
                  Encapsulating concerns such that they are only dealt with
                  uniquely in a few places
                </li>
                <li>
                  Enabling <em>good</em> reuse of functionality (as opposed to
                  simply focusing on de-duplication of code as text)
                </li>
                <li>Applying friction to make bad code harder to write</li>
              </ul>
              <h1 id="approaches"><a href="#approaches">Approaches</a></h1>
              <p>
                A common way to layer code is by its <em>applicability</em>. In
                this way layers help answer the question, 'When does it makes
                sense to (re)use this code for the problem we are solving?'
                Exploring this in a business setting we may define layers like
                this:
              </p>
              <p>
                <img
                  src="/images/layering/business-layering.png"
                  alt="Layering for business. The layers are listed along with an example for each."
                />
              </p>
              <p>Breaking these layers down from bottom to top:</p>
              <ul>
                <li>
                  <p>
                    <strong>Language standard library</strong> code provides the
                    very basics of working in whatever programming language you
                    choose. Some languages provide more comprehensive libraries
                    than others. JavaScript for example doesn't have a strong
                    standard library. (It has been getting better over time.)
                    The features the language provides are ever present and
                    generally applicable to solving problems.
                  </p>
                  <p>
                    In terms of mental overhead, it is common to imply everyone
                    working in a language is familiar with the standard library.
                    On the flip side, don't use all of a language's standard
                    library just for the sake of it. Standard libraries can be
                    bad, deprecated, broken, obscure code too, for example
                    JavaScript's <code>Date</code> object.
                  </p>
                </li>
                <li>
                  <p>
                    <strong>Utilities</strong> cover the short-comings of the
                    standard library and paper over the ever present language
                    problems with better features. For example, Lodash is a
                    common open-source &quot;utility belt&quot; to compensate
                    for JavaScript's lacking set. Utilities need not be
                    open-source, but it's a good rule of thumb that if you
                    weren't comfortable open sourcing the code, it probably
                    isn't a utility.
                  </p>
                  <p>
                    Most often the set of utilities you have will be small
                    because there are few constructs one can write that are both
                    very generic and generally applicable.
                  </p>
                </li>
                <li>
                  <p>
                    <strong>Primitives</strong> are where we start building
                    themes of code, things most programs need to deal with to be
                    useful programs. This includes storage (database access or
                    access to file systems), networking, compute management
                    (process or thread management), secrets, logging, and
                    monitoring. Conceivably anything you would build may rely on
                    these primitive pieces to meet its requirements.
                  </p>
                  <p>
                    Note that these themes can be quite complex, unlike
                    utilities which definitely ought to have guessable, simple
                    internals and low complexity. Primitives juggle the problem
                    of exposing just enough flexibility to use cases while
                    maintaining good commonalities.
                  </p>
                  <p>
                    Primitives might be thought of as the &quot;building
                    blocks&quot; of the code because they are composed together
                    to solve most problems. They may be underpinned by full
                    systems. For example managing the database servers could be
                    encapsulated: you use the database access primitive and you
                    get the management for free conceptually.
                  </p>
                </li>
                <li>
                  <p>
                    <strong>General concerns</strong> are answers to somewhat
                    common problems. We can take email as an example; most code
                    shouldn't shoulder the complexity of database storage,
                    sending servers, etc. So we build on primitives and bundle
                    up email as a concern.
                  </p>
                  <p>
                    These are less applicable than primitives and ought to be
                    more prescriptive about how they are applied in both the
                    code interface and documentation. Quite a many applications
                    do not require email, for example.
                  </p>
                </li>
                <li>
                  <p>
                    <strong>Business concerns</strong> are where we actually do
                    something useful. It can certainly be strange to say that
                    because all the layers we've previous described are so
                    complex, but it is true: thus far we've only built tools.
                    This layer is where we apply them to specific problems.
                    Things in this layer are least applicable to anything else.
                  </p>
                  <p>
                    If we built a feature of sending weekly reminders about how
                    much money someone made, we would leverage:
                  </p>
                  <ul>
                    <li>The email concern to send the emails out</li>
                    <li>
                      The data stored the database to pull completed
                      transactions
                    </li>
                    <li>
                      The language's built-in <code>Array.reduce</code> method
                      to sum up the totals
                    </li>
                  </ul>
                  <p>
                    In this way, business concerns leverage the lower layers to
                    make stuff happen.
                  </p>
                </li>
              </ul>
              <p>
                The above layering is pretty common in larger organizations'
                engineering team structures and code bases, but with cooler
                names:
              </p>
              <ul>
                <li>Primitives â†’ Infrastructure</li>
                <li>General concerns â†’ Platform</li>
                <li>Business concerns â†’ Product</li>
              </ul>
              <h2 id="example:-security">
                <a href="#example:-security">Example: security</a>
              </h2>
              <p>
                Multiple layering strategies can co-exist and fit within each
                other. To add one more example beside applicability, we can look
                at security. Specifically, let's talk about guarding against
                security vulnerabilities in the code that we write.
              </p>
              <p>
                <img
                  src="/images/layering/security-layering.png"
                  alt="Layering for security. We establish a trust boundary to allow engineers to indirectly use unsafe layers."
                />
              </p>
              <p>Breaking it down:</p>
              <ul>
                <li>
                  <p>
                    <strong>Raw, abusable features</strong> exist. They need to
                    exist to enable all of the cool stuff we build. Some are
                    better than others certainly insofar as making it most clear
                    what is safe and isn't. The Document Object Model (DOM)
                    allows low level access to web pages, loading scripts and
                    other assets.
                  </p>
                </li>
                <li>
                  <p>
                    The <strong>trust boundary</strong> is the critical layer we
                    use to encapsulate the above risk. It doesn't scale for each
                    implementation built on top of the features above to carry
                    the mental overhead or the risk. So the trust boundary
                    restricts access to the lower interface and receives much
                    more scrutiny, testing, and rigor.
                  </p>
                  <p>
                    For example, React wraps the DOM to
                    <a
                      href="https://reactjs.org/docs/introducing-jsx.html#jsx-prevents-injection-attacks"
                      >safely encode HTML content</a
                    >
                    by default. This solves issues with cross-site scripting
                    (XSS) and content injection attacks.
                  </p>
                  <pre><code class="language-js">&lt;p&gt;{<span class="hljs-string">&#x27;&lt;script&gt;evil()&lt;/script&gt;&#x27;</span>}&lt;/p&gt;
<span class="hljs-comment">//=&gt; &lt;p&gt;&amp;lt;script&amp;gt;evil()&amp;lt;/script&amp;gt;&lt;/p&gt;</span>
</code></pre>
                </li>
                <li>
                  <p>
                    The <strong>use cases</strong> are the individual
                    implementations. The goal is to have the code written at
                    this layer impossible to screw up. Leveraging the trust
                    boundary, the unsafe sharp edges aren't bleeding into
                    everything else.
                  </p>
                  <p>
                    React does give an escape hatch
                    <code>dangerouslySetInnerHTML</code> to work around this
                    safety, but at least the risk is more obvious.
                  </p>
                  <pre><code class="language-js">&lt;<span class="hljs-title class_">MyComponent</span> dangerouslySetInnerHTML={{ <span class="hljs-attr">__html</span>: htmlString }} /&gt;
</code></pre>
                </li>
              </ul>
              <h1 id="evolution"><a href="#evolution">Evolution</a></h1>
              <p>
                It is fair to say most code is not written with layering in
                mind. As was touched on earlier, this is pretty understandable.
                When you are starting from scratch the layers may not be obvious
                in the beginning. If you are implementing weekly reminders but
                haven't built any other email feature, it may not be obvious
                there are parts to a full email service here.
              </p>
              <p>Some good hints you might want to look into layering:</p>
              <ul>
                <li>
                  <p>
                    The <strong>Rule of Three</strong> basically says once
                    you've written similar things three times start looking for
                    commonalities. The weekly reminder email may be the only use
                    case for awhile so introducing layering too early may frame
                    solutions too closely to that exact shape of problem. By the
                    time you also have welcome and password reset emails, you'll
                    hopefully see a pattern forming to start building around.
                  </p>
                </li>
                <li>
                  <p>
                    Too much cognitive overhead to maintaining or adding new
                    features. There are many ways to combat this, layering is
                    one of them.
                  </p>
                  <p>
                    In our security example, if we found a vulnerability we
                    needed to address we wouldn't need to scour all the code to
                    patch it. We get it fixed at the trust boundary and every
                    usage benefits with no or minimal work.
                  </p>
                  <p>
                    In our applicability example, ideally most work can be done
                    in the mindset of one layer.
                  </p>
                </li>
                <li>
                  <p>
                    Spaghetti special casing of 'this or that' riddled
                    throughout the code. For example, for customer A send this
                    email otherwise do that other thing. These types of checks
                    are very costly and layering can apply counter pressure and
                    friction to these types of changes.
                  </p>
                  <p>
                    In our applicability example, lower level primitives and
                    concerns would not have a concept of &quot;customers.&quot;
                    As such it would feel really bad and be quite brittle to
                    hack up these lower layers to handle a business requirement.
                    This would however be easier at the higher levels where the
                    cost of getting it wrong is lower.
                  </p>
                  <p>
                    Similarly in our security example, if we riddled the trust
                    boundary with special casing it would defeat a lot of the
                    value of having the strict separation in the first place.
                  </p>
                </li>
              </ul>
              <p>
                Knowing when applying layering makes sense and how to do so
                takes practice and good understanding of the situation. It's
                important to acknowledge layering for its own sake ought not be
                a goal, but for the benefits it should deliver. Layers are
                always a work in progress.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
