<!doctype html>
<html lang="en-US">
  <head>
    <title>Before you before</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="Your test framework supports before/after hooks, don't use them."
    />
    <meta name="robots" content="index, follow" />

    <link
      rel="canonical"
      href="https://jew.ski/article/before-you-before/index.html"
    />

    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/logo192.png" />

    <meta name="theme-color" content="#178bfb" />

    <meta property="og:title" content="Before you before" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Chris Andrejewski" />
    <meta property="og:url" content="/article/before-you-before/index.html" />

    <meta property="twitter:card" content="summary" />
    <meta name="twitter:site" content="compooter" />
    <meta name="twitter:title" content="Before you before" />
    <meta
      name="twitter:description"
      content="Your test framework supports before/after hooks, don't use them."
    />

    <link rel="stylesheet" href="/stylesheet/highlight-atom-one.css" />
    <style data-styled="true" data-styled-version="6.1.17">
      .bctNTf {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .bctNTf {
          color: #5eb6ff;
        }
      } /*!sc*/
      data-styled.g1[id='sc-Qotzb'] {
        content: 'bctNTf,';
      } /*!sc*/
      .hxbvAH {
        padding-bottom: 4rem;
      } /*!sc*/
      data-styled.g2[id='sc-fYsHOw'] {
        content: 'hxbvAH,';
      } /*!sc*/
      .debzsy {
        background-color: #fff;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .debzsy {
          background-color: #16202e;
        }
      } /*!sc*/
      data-styled.g3[id='sc-dKREkF'] {
        content: 'debzsy,';
      } /*!sc*/
      .dtgyPg {
        padding: 0px 1rem;
        max-width: 720px;
        margin: 0px auto;
      } /*!sc*/
      data-styled.g4[id='sc-fWnslK'] {
        content: 'dtgyPg,';
      } /*!sc*/
      .eyyqef {
        margin: 15px 0em;
      } /*!sc*/
      .eyyqef:first-child {
        margin-top: 0px;
      } /*!sc*/
      .eyyqef:last-child {
        margin-bottom: 0px;
      } /*!sc*/
      data-styled.g5[id='sc-dIMoHT'] {
        content: 'eyyqef,';
      } /*!sc*/
      .hkwuxz {
        padding-top: 3rem;
        margin-bottom: 3rem;
      } /*!sc*/
      data-styled.g6[id='sc-iQQCXo'] {
        content: 'hkwuxz,';
      } /*!sc*/
      .foDfFI {
        font-size: 3rem;
        margin: 0px;
      } /*!sc*/
      @media (max-width: 720px) {
        .foDfFI {
          font-size: 1.8rem;
        }
      } /*!sc*/
      data-styled.g7[id='sc-gDpztx'] {
        content: 'foDfFI,';
      } /*!sc*/
      .iwpgrf {
        margin: 0;
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .iwpgrf {
          color: #dbe0e7;
        }
      } /*!sc*/
      data-styled.g8[id='sc-kpOvIu'] {
        content: 'iwpgrf,';
      } /*!sc*/
      .leFObR {
        display: inline-block;
        font-size: 0.9rem;
        line-height: 1rem;
        background-color: #dcefff;
        color: #151515;
        border-radius: 3px;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0.5rem 0.25rem 0;
        text-decoration: none;
        white-space: nowrap;
      } /*!sc*/
      .leFObR:hover {
        text-decoration: underline;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .leFObR {
          background-color: #2f3d4e;
          color: #c8d2e0;
        }
      } /*!sc*/
      data-styled.g9[id='sc-icnseD'] {
        content: 'leFObR,';
      } /*!sc*/
      .iLjxYJ {
        color: inherit;
        text-decoration: none;
      } /*!sc*/
      .iLjxYJ:hover span {
        text-decoration: underline;
      } /*!sc*/
      .iLjxYJ:hover:after {
        opacity: 1;
      } /*!sc*/
      .iLjxYJ:after {
        content: 'ðŸ”—';
        padding: 0 0.5rem;
        font-size: 1rem;
        opacity: 0.25;
      } /*!sc*/
      data-styled.g10[id='sc-jMsorb'] {
        content: 'iLjxYJ,';
      } /*!sc*/
      * {
        box-sizing: border-box;
      } /*!sc*/
      body {
        margin: 0px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica,
          Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
          'Segoe UI Symbol';
        background-color: #eff7fd;
        color: #000;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #0d1117;
          color: #fff;
        }
      } /*!sc*/
      data-styled.g12[id='sc-global-kFwHxP1'] {
        content: 'sc-global-kFwHxP1,';
      } /*!sc*/
      .jjMGJZ {
        display: flex;
        justify-content: space-between;
        align-items: center;
      } /*!sc*/
      .jjMGJZ h1 {
        font-size: 1.5rem;
        padding: 1rem 0px;
        margin: 0;
      } /*!sc*/
      .jjMGJZ h1 a {
        text-decoration: none;
        color: inherit;
      } /*!sc*/
      .jjMGJZ h1 a:hover {
        text-decoration: underline;
      } /*!sc*/
      @media (max-width: 720px) {
        .jjMGJZ .sc-jJAtPt {
          display: none;
        }
      } /*!sc*/
      data-styled.g14[id='sc-cUiCeM'] {
        content: 'jjMGJZ,';
      } /*!sc*/
      .gdJarr {
        border-top: 2px solid #d7d7d7;
        margin: 4rem 0;
        padding-top: 4rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .gdJarr {
          border-color: #4c545e;
        }
      } /*!sc*/
      data-styled.g54[id='sc-gDVcuj'] {
        content: 'gdJarr,';
      } /*!sc*/
      .hpaLEJ h1 > a,
      .hpaLEJ h2 > a,
      .hpaLEJ h3 > a,
      .hpaLEJ h4 > a,
      .hpaLEJ h5 > a,
      .hpaLEJ h6 > a {
        color: inherit;
        text-decoration: none;
      } /*!sc*/
      .hpaLEJ h1 > a:hover,
      .hpaLEJ h2 > a:hover,
      .hpaLEJ h3 > a:hover,
      .hpaLEJ h4 > a:hover,
      .hpaLEJ h5 > a:hover,
      .hpaLEJ h6 > a:hover {
        text-decoration: underline;
      } /*!sc*/
      .hpaLEJ p,
      .hpaLEJ li {
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .hpaLEJ p,
        .hpaLEJ li {
          color: #dbe0e7;
        }
      } /*!sc*/
      .hpaLEJ a {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .hpaLEJ a {
          color: #5eb6ff;
        }
      } /*!sc*/
      .hpaLEJ ul {
        padding-left: 1rem;
      } /*!sc*/
      .hpaLEJ code {
        font-family: Monaco, monospace;
      } /*!sc*/
      .hpaLEJ h1 code,
      .hpaLEJ h2 code,
      .hpaLEJ h3 code,
      .hpaLEJ h4 code,
      .hpaLEJ h5 code,
      .hpaLEJ h6 code,
      .hpaLEJ li code,
      .hpaLEJ p code {
        font-size: 0.9em;
        padding: 0 0.25em;
        border-radius: 3px;
        background-color: #eff7fd;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .hpaLEJ h1 code,
        .hpaLEJ h2 code,
        .hpaLEJ h3 code,
        .hpaLEJ h4 code,
        .hpaLEJ h5 code,
        .hpaLEJ h6 code,
        .hpaLEJ li code,
        .hpaLEJ p code {
          background-color: #2b3644;
        }
      } /*!sc*/
      .hpaLEJ pre {
        background-color: #eff7fd;
        padding: 0.5rem 0.75rem;
        overflow-x: scroll;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .hpaLEJ pre {
          background-color: #2b3645;
        }
      } /*!sc*/
      .hpaLEJ img {
        display: block;
        max-width: 100%;
        max-height: 520px;
        font-size: 0;
        margin: 0px auto;
        padding: 0px;
      } /*!sc*/
      .hpaLEJ video {
        display: block;
        margin: 1rem auto;
      } /*!sc*/
      .hpaLEJ figure {
        text-align: center;
        margin: 20px 0px;
      } /*!sc*/
      .hpaLEJ figure img {
        display: block;
        max-width: 90vw;
        margin: 0px auto;
      } /*!sc*/
      .hpaLEJ figure figcaption {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px auto;
      } /*!sc*/
      .hpaLEJ .cali-collage {
        padding: 20px 0px;
        text-align: center;
      } /*!sc*/
      .hpaLEJ .cali-collage img {
        display: inline-block;
        margin: 10px;
        max-width: 95vw;
        vertical-align: middle;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      } /*!sc*/
      data-styled.g55[id='sc-bpuAaX'] {
        content: 'hpaLEJ,';
      } /*!sc*/
      .gPIOea {
        text-align: center;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .gPIOea {
          color: #dbe0e7;
        }
      } /*!sc*/
      .gPIOea h3 {
        margin: 0.5em 0;
      } /*!sc*/
      .gPIOea p {
        margin: 0;
      } /*!sc*/
      data-styled.g56[id='sc-fPyrPm'] {
        content: 'gPIOea,';
      } /*!sc*/
    </style>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-G3SKTPFTEZ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag('js', new Date())
      gtag('config', 'G-G3SKTPFTEZ')
    </script>
  </head>
  <body>
    <div class="sc-dKREkF debzsy">
      <div class="sc-fYsHOw hxbvAH">
        <div class="sc-dKREkF debzsy">
          <div class="sc-fWnslK dtgyPg">
            <nav class="sc-cUiCeM jjMGJZ">
              <h1><a href="/">Chris Andrejewski</a></h1>
            </nav>
          </div>
        </div>
        <div class="sc-fWnslK dtgyPg">
          <div class="sc-iQQCXo hkwuxz">
            <p class="sc-kpOvIu iwpgrf">
              <a href="/writing" class="sc-icnseD leFObR">Articles</a
              ><a
                href="/category/engineering/index.html"
                class="sc-icnseD leFObR"
                >Engineering</a
              >
            </p>
            <h1 class="sc-gDpztx foDfFI">
              <a href="#" class="sc-jMsorb iLjxYJ"
                ><span>Before you before</span></a
              >
            </h1>
            <p class="sc-kpOvIu iwpgrf">
              Your test framework supports before/after hooks, don&#x27;t use
              them.
            </p>
          </div>
          <div class="sc-dIMoHT eyyqef">
            <div class="sc-bpuAaX hpaLEJ">
              <p>
                Most test frameworks have a concept of hooks. These hooks deal
                with aspects of setting up the situation where a test can run,
                and then cleaning that situation up. These hooks are commonly
                called <code>before</code> and <code>after</code> with plenty of
                different names, modifiers, and behaviors between
                implementations. They are often declared and execute like this:
              </p>
              <pre><code class="language-js"><span class="hljs-title function_">before</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">createDatabase</span>()
})

<span class="hljs-title function_">testCase</span>(<span class="hljs-string">&#x27;this is a test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// assert something dependent on the database</span>
})

<span class="hljs-title function_">testCase</span>(<span class="hljs-string">&#x27;this is another test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// assert something dependent on the database</span>
})

<span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">destroyDatabase</span>()
})
</code></pre>
              <p>
                While common to test frameworks and interesting to implement,
                hooks ought to be avoided in tests. Instead of hooks, prefer to
                use plain language constructs such as functions to serve the
                same purpose:
              </p>
              <pre><code class="language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withDatabase</span>(<span class="hljs-params">func</span>) {
  <span class="hljs-title function_">createDatabase</span>()
  <span class="hljs-title function_">func</span>()
  <span class="hljs-title function_">destroyDatabase</span>()
}

<span class="hljs-title function_">testCase</span>(<span class="hljs-string">&#x27;this is a test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">withDatabase</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// assert something dependent on the database</span>
  })
})

<span class="hljs-title function_">testCase</span>(<span class="hljs-string">&#x27;this is another test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">withDatabase</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// assert something dependent on the database</span>
  })
})
</code></pre>
              <p>
                There are many significant benefits to using functions over
                hooks:
              </p>
              <ul>
                <li>
                  <p>
                    We get <strong>improved code locality</strong> because
                    everything we need to understand the test case is in the
                    test case. Not only do test frameworks support before/after,
                    they support <em>multiple</em> before/after hooks. This can
                    get pretty crazy as you can find code with hooks shared and
                    registered across many files.
                  </p>
                </li>
                <li>
                  <p>
                    We use <strong>less magic</strong>. Everyone has a baseline
                    understanding of functions, methods, and calling order.
                    Hooks like before/after can and are implemented in crazy
                    ways. Minimizing the mental burden of writing against a
                    specific test framework is advantageous.
                  </p>
                </li>
                <li>
                  <p>
                    We can do <strong>proper composition of code</strong>. Hooks
                    like before/after aren't good for organizing and reusing
                    code because they can only be registered with the test
                    framework. This inversion of control to the framework is
                    very limiting. We can't enforce
                    <code>beforeB</code> requires <code>beforeA</code> or
                    <code>afterC</code> must be called after
                    <code>beforeC</code>; this is all implicit. Functions on the
                    other hand compose so we can do these things plainly:
                  </p>
                  <pre><code class="language-js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">setupB</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-title function_">setupA</span>()
  <span class="hljs-comment">// do set up dependent on A</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">withC</span> = (<span class="hljs-params">fn</span>) =&gt; {
  <span class="hljs-title function_">setupC</span>()
  <span class="hljs-title function_">fn</span>()
  <span class="hljs-title function_">tearDownC</span>()
}
</code></pre>
                </li>
                <li>
                  <p>
                    <strong>No extra work</strong> is done for a test case that
                    doesn't need it. Very often some tests will require more
                    convoluted setups than others and tests sharing that
                    <code>before</code> will pay a price. This extra work is
                    wasteful, but also usually noise that muddles what is
                    intended to be under test.
                  </p>
                </li>
                <li>
                  <p>
                    We <strong>don't have to restate the facts</strong> of what
                    happens in the plain function. If you're working in a typed
                    language, you'll often feel the friction of asserting that
                    the <code>before</code> hook did the setup as expected.
                    Because it was done in a far-off place, the type system
                    cannot help make the connections. This leads to adding more
                    noise to satisfy the typechecker or annotations to opt-out
                    of types, making the tests get less out of typing.
                  </p>
                  <p>
                    Beyond types, asserting side-effects have occurred also can
                    suffer from this first-verify-before-then-test issue. This
                    happens very naturally when there's an implicit assumption
                    about how the <code>before</code> should run. Since
                    <code>before</code> is shared and may be refactored, we may
                    need some verification to
                    <em>test the <code>before</code></em> is doing the right
                    thing. Being explicit with functions, we don't need this
                    defensive checking.
                  </p>
                </li>
                <li>
                  <p>
                    We <strong>don't have a dumping ground</strong> for
                    unrelated code. Hooks put negative social pressure on the
                    growth of the code. Using <code>before</code> may feel nice:
                    test cases are shorter because all the work is in
                    <code>before</code>! While true, this also means
                    <em>all the work is in <code>before</code></em
                    >. As new code is added, people most often repeat
                    established patterns. This leads to more and more code
                    dumped into <code>before</code>, it becomes a junk drawer
                    which exacerbates all the above issues.
                  </p>
                </li>
                <li>
                  <p>
                    Even more problems exist with
                    <strong>different implementations</strong> of hooks. We
                    can't cover all the issues that only some test frameworks
                    exhibit, but rest assured this list is not exhaustive.
                    Functions, on the other hand, have much more portable
                    semantics and are more generally applicable.
                  </p>
                </li>
              </ul>
            </div>
          </div>
          <div class="sc-dIMoHT eyyqef">
            <p class="sc-kpOvIu iwpgrf">
              <small
                ><time
                  datetime="2020-11-04T00:00:00.000Z"
                  title="2020-11-04T00:00:00.000Z"
                  >Published 11/4/2020</time
                ></small
              >
            </p>
          </div>
          <div
            class="sc-gDVcuj gdJarr newsletter-container"
            data-frame-src="https://newsletter.jew.ski/frame/subscribe"
          >
            <div class="sc-fPyrPm gPIOea">
              <h3>Subscribe for new articles</h3>
              <div class="newsletter-form"></div>
              <p>
                <small
                  >Or add the
                  <a href="/writing/feed.atom.xml" class="sc-Qotzb bctNTf"
                    >Atom feed</a
                  >
                  to your feed reader.</small
                >
              </p>
            </div>
            <script src="https://newsletter-js.jew.ski/v1/subscribe-embed.js"></script>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
