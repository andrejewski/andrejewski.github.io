<!DOCTYPE html>
<html>
  <head>
    <title>Before you before</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="Your test framework supports before/after hooks, don't use them."
    />
    <meta name="robots" content="noindex, nofollow" />

    <link rel="canonical" href="/article/before-you-before/index.html" />
    <link rel="icon" href="/favicon.ico" />
    <link rel="apple-touch-icon" href="/logo192.png" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#178bfb" />

    <meta property="og:title" content="Before you before" />
    <meta property="og:type" content="article" />
    <meta property="og:site_name" content="Chris Andrejewski" />
    <meta property="og:url" content="/article/before-you-before/index.html" />

    <meta property="twitter:card" content="summary" />
    <meta name="twitter:site" content="compooter" />
    <meta name="twitter:title" content="Before you before" />
    <meta
      name="twitter:description"
      content="Your test framework supports before/after hooks, don't use them."
    />

    <link rel="stylesheet" href="/stylesheet/highlight-atom-one.css" />
    <style data-styled="true" data-styled-version="5.3.5">
      .cUDFKA {
        padding-bottom: 4rem;
      } /*!sc*/
      data-styled.g2[id='sc-gsnTZi'] {
        content: 'cUDFKA,';
      } /*!sc*/
      .ftgBFL {
        background-color: #fff;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ftgBFL {
          background-color: #16202e;
        }
      } /*!sc*/
      data-styled.g3[id='sc-dkzDqf'] {
        content: 'ftgBFL,';
      } /*!sc*/
      .iMPPhc {
        padding: 0px 1rem;
        max-width: 720px;
        margin: 0px auto;
      } /*!sc*/
      data-styled.g4[id='sc-hKMtZM'] {
        content: 'iMPPhc,';
      } /*!sc*/
      .jZkxEC {
        margin: 15px 0em;
      } /*!sc*/
      .jZkxEC:first-child {
        margin-top: 0px;
      } /*!sc*/
      .jZkxEC:last-child {
        margin-bottom: 0px;
      } /*!sc*/
      data-styled.g5[id='sc-eCYdqJ'] {
        content: 'jZkxEC,';
      } /*!sc*/
      .eBtA-dh {
        margin: 3rem 0;
      } /*!sc*/
      data-styled.g6[id='sc-jSMfEi'] {
        content: 'eBtA-dh,';
      } /*!sc*/
      .kaKiDU {
        font-size: 3rem;
        margin: 0px;
      } /*!sc*/
      @media (max-width: 720px) {
        .kaKiDU {
          font-size: 1.8rem;
        }
      } /*!sc*/
      data-styled.g7[id='sc-gKXOVf'] {
        content: 'kaKiDU,';
      } /*!sc*/
      .xFOWy {
        margin: 0;
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .xFOWy {
          color: #dbe0e7;
        }
      } /*!sc*/
      data-styled.g8[id='sc-iBkjds'] {
        content: 'xFOWy,';
      } /*!sc*/
      .hmuBWy {
        display: inline-block;
        font-size: 0.9rem;
        line-height: 1rem;
        background-color: #9ed2f9;
        color: #151515;
        border-radius: 3px;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem 0.5rem 0.25rem 0;
        -webkit-text-decoration: none;
        text-decoration: none;
        white-space: nowrap;
      } /*!sc*/
      .hmuBWy:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .hmuBWy {
          background-color: #2f3d4e;
          color: #c8d2e0;
        }
      } /*!sc*/
      data-styled.g9[id='sc-ftvSup'] {
        content: 'hmuBWy,';
      } /*!sc*/
      .iHVwPn {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .iHVwPn:hover span {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .iHVwPn:hover:after {
        opacity: 1;
      } /*!sc*/
      .iHVwPn:after {
        content: 'ðŸ”—';
        padding: 0 0.5rem;
        font-size: 1rem;
        opacity: 0.25;
      } /*!sc*/
      data-styled.g10[id='sc-papXJ'] {
        content: 'iHVwPn,';
      } /*!sc*/
      * {
        box-sizing: border-box;
      } /*!sc*/
      body {
        margin: 0px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica,
          Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
          'Segoe UI Symbol';
        background-color: #eff7fd;
        color: #000;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #0d1117;
          color: #fff;
        }
      } /*!sc*/
      data-styled.g12[id='sc-global-kFwHxP1'] {
        content: 'sc-global-kFwHxP1,';
      } /*!sc*/
      .kylQxs {
        display: -webkit-box;
        display: -webkit-flex;
        display: -ms-flexbox;
        display: flex;
        -webkit-box-pack: justify;
        -webkit-justify-content: space-between;
        -ms-flex-pack: justify;
        justify-content: space-between;
        -webkit-align-items: center;
        -webkit-box-align: center;
        -ms-flex-align: center;
        align-items: center;
      } /*!sc*/
      .kylQxs h1 {
        font-size: 1.5rem;
        padding: 1rem 0px;
        margin: 0;
      } /*!sc*/
      .kylQxs h1 a {
        -webkit-text-decoration: none;
        text-decoration: none;
        color: inherit;
      } /*!sc*/
      .kylQxs h1 a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      @media (max-width: 720px) {
        .kylQxs .sc-kDDrLX {
          display: none;
        }
      } /*!sc*/
      data-styled.g14[id='sc-iqcoie'] {
        content: 'kylQxs,';
      } /*!sc*/
      .ismAZz h1 > a,
      .ismAZz h2 > a,
      .ismAZz h3 > a,
      .ismAZz h4 > a,
      .ismAZz h5 > a,
      .ismAZz h6 > a {
        color: inherit;
        -webkit-text-decoration: none;
        text-decoration: none;
      } /*!sc*/
      .ismAZz h1 > a:hover,
      .ismAZz h2 > a:hover,
      .ismAZz h3 > a:hover,
      .ismAZz h4 > a:hover,
      .ismAZz h5 > a:hover,
      .ismAZz h6 > a:hover {
        -webkit-text-decoration: underline;
        text-decoration: underline;
      } /*!sc*/
      .ismAZz p,
      .ismAZz li {
        line-height: 1.5rem;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ismAZz p,
        .ismAZz li {
          color: #dbe0e7;
        }
      } /*!sc*/
      .ismAZz a {
        color: rgb(6, 90, 163);
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ismAZz a {
          color: #5eb6ff;
        }
      } /*!sc*/
      .ismAZz ul {
        padding-left: 1rem;
      } /*!sc*/
      .ismAZz code {
        font-family: Monaco, monospace;
      } /*!sc*/
      .ismAZz h1 code,
      .ismAZz h2 code,
      .ismAZz h3 code,
      .ismAZz h4 code,
      .ismAZz h5 code,
      .ismAZz h6 code,
      .ismAZz li code,
      .ismAZz p code {
        font-size: 0.9em;
        padding: 0 0.25em;
        border-radius: 3px;
        background-color: #eff7fd;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ismAZz h1 code,
        .ismAZz h2 code,
        .ismAZz h3 code,
        .ismAZz h4 code,
        .ismAZz h5 code,
        .ismAZz h6 code,
        .ismAZz li code,
        .ismAZz p code {
          background-color: #2b3644;
        }
      } /*!sc*/
      .ismAZz pre {
        background-color: #eff7fd;
        padding: 0.5rem 0.75rem;
        overflow-x: scroll;
      } /*!sc*/
      @media (prefers-color-scheme: dark) {
        .ismAZz pre {
          background-color: #2b3645;
        }
      } /*!sc*/
      .ismAZz img {
        display: block;
        max-width: 100%;
        max-height: 520px;
        font-size: 0;
        margin: 0px auto;
        padding: 0px;
      } /*!sc*/
      .ismAZz video {
        display: block;
        margin: 1rem auto;
      } /*!sc*/
      .ismAZz figure {
        text-align: center;
        margin: 20px 0px;
      } /*!sc*/
      .ismAZz figure img {
        display: block;
        max-width: 90vw;
        margin: 0px auto;
      } /*!sc*/
      .ismAZz figure figcaption {
        opacity: 0.9;
        font-size: 1.1em;
        margin: 10px auto;
      } /*!sc*/
      .ismAZz .cali-collage {
        padding: 20px 0px;
        text-align: center;
      } /*!sc*/
      .ismAZz .cali-collage img {
        display: inline-block;
        margin: 10px;
        max-width: 95vw;
        vertical-align: middle;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      } /*!sc*/
      data-styled.g15[id='sc-crXcEl'] {
        content: 'ismAZz,';
      } /*!sc*/
    </style>

    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-G3SKTPFTEZ"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || []
      function gtag() {
        dataLayer.push(arguments)
      }
      gtag('js', new Date())
      gtag('config', 'G-G3SKTPFTEZ')
    </script>
  </head>
  <body>
    <div class="sc-dkzDqf ftgBFL">
      <div class="sc-gsnTZi cUDFKA">
        <div class="sc-dkzDqf ftgBFL">
          <div class="sc-hKMtZM iMPPhc">
            <nav class="sc-iqcoie kylQxs">
              <h1><a href="/">Chris Andrejewski</a></h1>
            </nav>
          </div>
        </div>
        <div class="sc-hKMtZM iMPPhc">
          <div class="sc-jSMfEi eBtA-dh">
            <p class="sc-iBkjds xFOWy">
              <a
                href="/category/engineering/index.html"
                class="sc-ftvSup hmuBWy"
                >Engineering</a
              >
            </p>
            <h1 class="sc-gKXOVf kaKiDU">
              <a href="#" class="sc-papXJ iHVwPn"
                ><span>Before you before</span></a
              >
            </h1>
            <p class="sc-iBkjds xFOWy">
              Your test framework supports before/after hooks, don&#x27;t use
              them.
            </p>
          </div>
          <div class="sc-eCYdqJ jZkxEC">
            <div class="sc-crXcEl ismAZz">
              <p>
                Most test frameworks have a concept of hooks. These hooks deal
                with aspects of setting up the situation where a test can run,
                and then cleaning that situation up. These hooks are commonly
                called <code>before</code> and <code>after</code> with plenty of
                different names, modifiers, and behaviors between
                implementations. They are often declared and execute like this:
              </p>
              <pre><code class="language-js"><span class="hljs-title function_">before</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">createDatabase</span>()
})

<span class="hljs-title function_">testCase</span>(<span class="hljs-string">&#x27;this is a test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// assert something dependent on the database</span>
})

<span class="hljs-title function_">testCase</span>(<span class="hljs-string">&#x27;this is another test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// assert something dependent on the database</span>
})

<span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">destroyDatabase</span>()
})
</code></pre>
              <p>
                While common to test frameworks and interesting to implement,
                hooks ought to be avoided in tests. Instead of hooks, prefer to
                use plain language constructs such as functions to serve the
                same purpose:
              </p>
              <pre><code class="language-js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">withDatabase</span>(<span class="hljs-params">func</span>) {
  <span class="hljs-title function_">createDatabase</span>()
  <span class="hljs-title function_">func</span>()
  <span class="hljs-title function_">destroyDatabase</span>()
}

<span class="hljs-title function_">testCase</span>(<span class="hljs-string">&#x27;this is a test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">withDatabase</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// assert something dependent on the database</span>
  })
})

<span class="hljs-title function_">testCase</span>(<span class="hljs-string">&#x27;this is another test&#x27;</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">withDatabase</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// assert something dependent on the database</span>
  })
})
</code></pre>
              <p>
                There are many significant benefits to using functions over
                hooks:
              </p>
              <ul>
                <li>
                  <p>
                    We get <strong>improved code locality</strong> because
                    everything we need to understand the test case is in the
                    test case. Not only do test frameworks support before/after,
                    they support <em>multiple</em> before/after hooks. This can
                    get pretty crazy as you can find code with hooks shared and
                    registered across many files.
                  </p>
                </li>
                <li>
                  <p>
                    We use <strong>less magic</strong>. Everyone has a baseline
                    understanding of functions, methods, and calling order.
                    Hooks like before/after can and are implemented in crazy
                    ways. Minimizing the mental burden of writing against a
                    specific test framework is advantageous.
                  </p>
                </li>
                <li>
                  <p>
                    We can do <strong>proper composition of code</strong>. Hooks
                    like before/after aren't good for organizing and reusing
                    code because they can only be registered with the test
                    framework. This inversion of control to the framework is
                    very limiting. We can't enforce
                    <code>beforeB</code> requires <code>beforeA</code> or
                    <code>afterC</code> must be called after
                    <code>beforeC</code>; this is all implicit. Functions on the
                    other hand compose so we can do these things plainly:
                  </p>
                  <pre><code class="language-js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">setupB</span> = (<span class="hljs-params"></span>) =&gt; {
  <span class="hljs-title function_">setupA</span>()
  <span class="hljs-comment">// do set up dependent on A</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">withC</span> = (<span class="hljs-params">fn</span>) =&gt; {
  <span class="hljs-title function_">setupC</span>()
  <span class="hljs-title function_">fn</span>()
  <span class="hljs-title function_">tearDownC</span>()
}
</code></pre>
                </li>
                <li>
                  <p>
                    <strong>No extra work</strong> is done for a test case that
                    doesn't need it. Very often some tests will require more
                    convoluted setups than others and tests sharing that
                    <code>before</code> will pay a price. This extra work is
                    wasteful, but also usually noise that muddles what is
                    intended to be under test.
                  </p>
                </li>
                <li>
                  <p>
                    We <strong>don't have to restate the facts</strong> of what
                    happens in the plain function. If you're working in a typed
                    language, you'll often feel the friction of asserting that
                    the <code>before</code> hook did the setup as expected.
                    Because it was done in a far-off place, the type system
                    cannot help make the connections. This leads to adding more
                    noise to satisfy the typechecker or annotations to opt-out
                    of types, making the tests get less out of typing.
                  </p>
                  <p>
                    Beyond types, asserting side-effects have occurred also can
                    suffer from this first-verify-before-then-test issue. This
                    happens very naturally when there's an implicit assumption
                    about how the <code>before</code> should run. Since
                    <code>before</code> is shared and may be refactored, we may
                    need some verification to
                    <em>test the <code>before</code></em> is doing the right
                    thing. Being explicit with functions, we don't need this
                    defensive checking.
                  </p>
                </li>
                <li>
                  <p>
                    We <strong>don't have a dumping ground</strong> for
                    unrelated code. Hooks put negative social pressure on the
                    growth of the code. Using <code>before</code> may feel nice:
                    test cases are shorter because all the work is in
                    <code>before</code>! While true, this also means
                    <em>all the work is in <code>before</code></em
                    >. As new code is added, people most often repeat
                    established patterns. This leads to more and more code
                    dumped into <code>before</code>, it becomes a junk drawer
                    which exacerbates all the above issues.
                  </p>
                </li>
                <li>
                  <p>
                    Even more problems exist with
                    <strong>different implementations</strong> of hooks. We
                    can't cover all the issues that only some test frameworks
                    exhibit, but rest assured this list is not exhaustive.
                    Functions, on the other hand, have much more portable
                    semantics and are more generally applicable.
                  </p>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
